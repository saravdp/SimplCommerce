name: CodeQL Analysis and Compare

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ['csharp'] # Manually specify C# language

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Initialize submodules
        run: git submodule update --init --recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '8.x'

      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Install dotnet-ef tool
        run: dotnet tool install --global dotnet-ef

      - name: Restore dependencies
        run: dotnet restore SimplCommerce.sln

      - name: Build the code
        run: dotnet build SimplCommerce.sln --configuration Release

      - name: Update database
        run: dotnet ef database update --project src/SimplCommerce.WebHost

      - name: Set up CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: csharp

      - name: Perform CodeQL Analysis
        run: |
          codeql database create --language=csharp --source-root=. --output=codeql-database
          codeql database analyze --database=codeql-database --output=results.qsarif
      - name: Initialize CodeQL tools
        uses: github/codeql-action/init@v3
        with:
          tools: https://github.com/dsp-testing/codeql-cli-nightlies/releases/download/codeql-bundle-20240307/codeql-bundle-linux64.tar.gz
